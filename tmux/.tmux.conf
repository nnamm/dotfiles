#------------------------------#
# Core & Terminal
#------------------------------#
# Color & Capability settings (reload-safe: no -a flag)
set -g default-terminal "tmux-256color"
set -g terminal-features "xterm-256color:RGB:usstyle,tmux-256color:RGB:usstyle"

# Undercurl support (Smulx: underline style, Seulc: underline color)
set -g terminal-overrides 'xterm-256color:Smulx=\E[4::%p1%dm:Seulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m,tmux-256color:Smulx=\E[4::%p1%dm:Seulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# General
set -g mouse on
set -sg escape-time 10     # Fix for Neovim/Vim delay
set -g focus-events on     # Focus events enabled for Neovim
set -g history-limit 50000 # Increased history size
set -g base-index 1        # Start window index at 1
set -g pane-base-index 1   # Start pane index at 1
set -g renumber-windows on # Auto renumber windows on close
set -g display-time 1000   # Message display duration
set -g extended-keys on    # Modifier key support(Neovim/Vim)

# Clipboard
set -s set-clipboard external

#------------------------------#
# Key Bindings
#------------------------------#
# Prefix Key: Ctrl-t
unbind C-b
set -g prefix C-t
bind C-t send-prefix

# Reload Config
bind r source-file ~/.tmux.conf \; display "Reloaded!"

# Split Panes (Keep current path)
bind \\ split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Pane Navigation (Vim-like)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind -n C-] select-pane -t :.+ # Cyclic pane navigation

# Pane Resizing (Vim-like, Repeatable)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Copy Mode (Vim-style)
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle

# Clipboard integration (OS detection)
# macOS
if-shell "uname | grep -q Darwin" {
    bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
}
# WSL2
if-shell "grep -qi microsoft /proc/version 2>/dev/null" {
    bind -T copy-mode-vi y send -X copy-pipe-and-cancel "clip.exe"
}
# Linux Wayland
if-shell '[ -n "$WAYLAND_DISPLAY" ]' {
    bind -T copy-mode-vi y send -X copy-pipe-and-cancel "wl-copy"
}
# Linux X11 (fallback)
if-shell '[ -n "$DISPLAY" ] && [ -z "$WAYLAND_DISPLAY" ] && ! grep -qi microsoft /proc/version 2>/dev/null' {
    bind -T copy-mode-vi y send -X copy-pipe-and-cancel "xclip -selection clipboard"
}

# Unbind Tab (Usually not needed unless it conflicts)
unbind Tab

# lazygit
bind g display-popup -d '#{pane_current_path}' -w80% -h80% -E lazygit

# Claude Code in Popup window
bind -r y run-shell '\
  SESSION="claude-$(echo #{pane_current_path} | md5sum | cut -c1-8)"; \
  tmux has-session -t "$SESSION" 2>/dev/null || \
  tmux new-session -d -s "$SESSION" -c "#{pane_current_path}" "claude"; \
  tmux display-popup -w80% -h80% -E "tmux attach-session -t $SESSION"'

#------------------------------#
# Status Bar
#------------------------------#
set -g status-position bottom
set -g status-interval 10     # Reduced frequency to lower CPU load with git scripts

# Colors (modern unified style)
set -g status-style 'fg=blue,bg=black'
set -g pane-active-border-style 'fg=colour39'
set -g pane-border-style 'fg=colour236'

# Window Status
set -g window-status-current-style 'fg=white'
set -g window-status-style dim
set -g window-status-current-format '#[fg=black,bg=blue] #I:#W #[fg=blue,bg=black]'
set -g window-status-format ' #I:#W '

# Left Panel
set -g status-left-length 100
set -g status-left '  #[fg=magenta]#($HOME/dotfiles/tmux/scripts/repo_name.sh "#{pane_current_path}") ┊ #($HOME/dotfiles/tmux/scripts/branch_name.sh "#{pane_current_path}") ┊ #{b:pane_current_path} ┊ '

# Right Panel
set -g status-right "#[fg=yellow]Window:#I  #[fg=cyan]Pane:#P  "
